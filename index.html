<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Consul3 by wangfakang</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Consul3</h1>
        <p class="header">consul+docker+registrator+consul_template+nginx</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/consul3/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/consul3/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/wangfakang/consul3">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/wangfakang">wangfakang</a></p>


      </header>
      <section>
        <p><code>使用consul+consul_template+registartor+docker进行动态管理nginx的upstream后端server:</code> </p>

<ul>
<li><p>基本原理就是：<br>
　　使用consul做服务发现（进行服务的注册类似etcd），使用consul_template(类似confd)进行nginx配置文件的更新，使用registartor进行检测docker上所起的服务并注册到指定的consul机器上．</p></li>
<li><p>快速搭建：</p></li>
</ul>

<h1>
<a id="一consul的搭建---" class="anchor" href="#%E4%B8%80consul%E7%9A%84%E6%90%AD%E5%BB%BA---" aria-hidden="true"><span class="octicon octicon-link"></span></a>一．consul的搭建   </h1>

<p>　　前面文章讲过consul的单机以及集群的搭建，下面不在详细介绍相关参数了：     </p>

<p>　　　　docker run -d -p 8500:8500  -p 53:53/udp --name=consul  gliderlabs/consul-server -bootstrap　-advertise 127.0.0.1<br>
　　　　
　　　　注意:-advertise参数表示的是:是给集群中的其他节点展现的地址.      </p>

<h1>
<a id="二registartor的搭建---" class="anchor" href="#%E4%BA%8Cregistartor%E7%9A%84%E6%90%AD%E5%BB%BA---" aria-hidden="true"><span class="octicon octicon-link"></span></a>二．registartor的搭建   </h1>

<pre><code>docker run -d \
--name=registrator \
--volume=/var/run/docker.sock:/tmp/docker.sock \
gliderlabs/registrator:latest \
consul://localhost:8500
</code></pre>

<p>　简单介绍下上面参数的含义：<br>
　　　　第三行表示把docker的socket文件挂载到该docker容器下　第五行表示当检测到docket上有新的服务的时候　会把其注册到指定的consul            </p>

<p>注意:此时是需要把localhost换成你搭建consul的那台机器的真实ip(对外出口ip),由于其docker默认使用的 bridge网络模式.        </p>

<h1>
<a id="三consul_template与nginx的搭建---" class="anchor" href="#%E4%B8%89consul_template%E4%B8%8Enginx%E7%9A%84%E6%90%AD%E5%BB%BA---" aria-hidden="true"><span class="octicon octicon-link"></span></a>三．consul_template与nginx的搭建   </h1>

<p>下面把其consul_template和nginx进行了dockerfile:
   使用docker build -t drname  .  进行生成镜像文件<br>
　　然后执行进行文件：<br>
　　　　docker run -it \
　　　　-e "CONSUL=$DOCKER_IP:8500" \
　　　　-e "SERVICE=test" \
　　　　-p 80:80 drname
上面表示当有名字为test服务的时候　此时就会把该test服务的server加载到nginx的upstream中去．<br>
-e参数表示给定docker中的变量赋值<br>
-p表示端口的映射<br>
-it是交互式  </p>

<p>注意本地的nginx.conf upstream.conf的编写，关于nginx相关讲解可以看前面文章．</p>

<p>Dockerfile:         </p>

<div class="highlight highlight-source-nginx"><pre>
<span class="pl-c">#tar -C /usr/local/bin --strip-components 1 -zxf -</span>
<span class="pl-k">ADD</span> consul-template /usr/local/bin/

<span class="pl-c">#Setup Consul Template Files</span>
<span class="pl-k">RUN</span> mkdir /etc/consul-templates
<span class="pl-k">ENV</span> CT_FILE /etc/consul-templates/nginx.conf

<span class="pl-c">#Setup Nginx File</span>
<span class="pl-k">ENV</span> NX_FILE /etc/nginx/conf.d/app.conf

<span class="pl-c">#Default Variables</span>
<span class="pl-k">ENV</span> CONSUL consul:8500
<span class="pl-k">ENV</span> SERVICE consul-8500

<span class="pl-c"># Command will</span>
<span class="pl-c"># 1. Write Consul Template File</span>
<span class="pl-c"># 2. Start Nginx</span>
<span class="pl-c"># 3. Start Consul Template</span>
<span class="pl-c">#ADD nginx.conf /etc/nginx/nginx.conf</span>

<span class="pl-k">CMD</span> echo <span class="pl-s">"events { worker_connections 100; }     \n\ </span>
<span class="pl-s">  http {                                 \n\</span>
<span class="pl-s">  upstream app {                         \n\</span>
<span class="pl-s">  least_conn;                            \n\</span>
<span class="pl-s">  {{range service <span class="pl-cce">\"</span><span class="pl-smi">$SERVICE</span><span class="pl-cce">\"</span>}}         \n\</span>
<span class="pl-s">  server  {{.Address}}:{{.Port}};        \n\</span>
<span class="pl-s">  {{else}}server 127.0.0.1:65535;{{end}} \n\ </span>
<span class="pl-s">}                                        \n\</span>
<span class="pl-s">server {                                 \n\</span>
<span class="pl-s">  listen 81 default_server;              \n\</span>
<span class="pl-s">  location / {                           \n\</span>
<span class="pl-s">    proxy_pass http://app;               \n\</span>
<span class="pl-s">  }                                      \n\</span>
<span class="pl-s">} }"</span> &gt; <span class="pl-smi">$CT_FILE</span>; \
/<span class="pl-k">usr/sbin</span>/nginx -c /etc/nginx/nginx.conf \
&amp; CONSUL_TEMPLATE_LOG=debug consul-template \
  -consul=<span class="pl-smi">$CONSUL</span> \
  -template <span class="pl-s">"<span class="pl-smi">$CT_FILE</span>:/etc/nginx/nginx.conf:/usr/sbin/nginx -c /etc/nginx/nginx.conf -s reload"</span>;
</pre></div>

<h1>
<a id="四测试---" class="anchor" href="#%E5%9B%9B%E6%B5%8B%E8%AF%95---" aria-hidden="true"><span class="octicon octicon-link"></span></a>四．测试   </h1>

<p>　　此时已经搭建好了　当我们使用docker进行启动一个名字为test的服务的时候，此时registator会检测到docker的socket有变化则会主动的把该服务注册到指定的consul上．然后consul_template发现指定的consul上的服务有变化的时候,会主动的更新nginx的配置文件，然后重启nginx.</p>

<p>　　如：<br>
　　　docker run -it \<br>
　　　-e "SERVICE_NAME=test" \<br>
　　　-p 8000:80 python/server    </p>

<h1>
<a id="communite--" class="anchor" href="#communite--" aria-hidden="true"><span class="octicon octicon-link"></span></a>Communite  </h1>

<p>在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流</p>

<ul>
<li>邮件(1031379296#qq.com, 把#换成@)</li>
<li>QQ: 1031379296</li>
<li>weibo: <a href="http://weibo.com/u/2786211992/home">@王发康</a>
</li>
</ul>

<h1>
<a id="thx" class="anchor" href="#thx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Thx</h1>

<ul>
<li>chunshengsterATgmail.com</li>
</ul>

<h1>
<a id="author" class="anchor" href="#author" aria-hidden="true"><span class="octicon octicon-link"></span></a>Author</h1>

<ul>
<li>Linux\nginx\golang\c\c++爱好者</li>
<li>欢迎一起交流  一起学习# </li>
<li>Others say good and Others good</li>
</ul>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("consul+docker+registrator+consul_template+nginx");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
